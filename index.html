<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>Hiragana Flashcards</title>
  <style>
    :root { --bg:#0b0b0f; --card:#141420; --text:#f2f2f7; --muted:#a1a1b3; --btn:#2a2a3a; --btn2:#3a3a55; --ok:#2ecc71; --bad:#ff5d5d; }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100svh;
      display: flex; align-items: center; justify-content: center;
      padding: 18px;
    }
    .wrap { width: min(520px, 100%); }
    header { display:flex; align-items:baseline; justify-content:space-between; gap:12px; margin-bottom:12px; }
    h1 { font-size: 18px; margin:0; letter-spacing: .2px; }
    .stats { font-size: 13px; color: var(--muted); display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .pill {
      padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.07);
    }
    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 18px 18px 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.06);
      user-select: none;
    }
    .toprow {
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .iconbtn {
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--btn);
      border: 1px solid rgba(255,255,255,.08);
      color: var(--text);
      font-weight: 750;
      font-size: 16px;
      cursor: pointer;
      touch-action: manipulation;
      white-space: nowrap;
    }
    .iconbtn:active { transform: translateY(1px); background: var(--btn2); }
    .big {
      display:flex; align-items:center; justify-content:center;
      min-height: 200px;
      font-size: 96px;
      line-height: 1;
      letter-spacing: 1px;
    }
    .small {
      display:flex; align-items:center; justify-content:center;
      margin-top: 10px;
      font-size: 22px;
      color: var(--muted);
      min-height: 32px;
    }
    .hint { text-align:center; margin-top: 12px; font-size: 12px; color: var(--muted); }
    .controls, .row2 {
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
    }
    button {
      appearance: none; border: 0;
      padding: 14px 12px;
      border-radius: 14px;
      background: var(--btn);
      color: var(--text);
      font-weight: 650;
      font-size: 15px;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,.08);
      touch-action: manipulation;
    }
    button:active { transform: translateY(1px); background: var(--btn2); }
    .toggles {
      margin-top: 14px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    label {
      display:flex; gap:8px; align-items:center;
      font-size: 13px; color: var(--muted);
    }
    input[type="checkbox"] { width: 18px; height: 18px; }

    .answerBox {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .answerInput {
      width: 100%;
      padding: 14px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    .answerInput::placeholder { color: rgba(241,241,255,.45); }
    .feedback {
      font-size: 18px;
      font-weight: 900;
      padding: 12px 12px;
      border-radius: 14px;
      min-width: 54px;
      text-align: center;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.06);
    }
    .ok { color: var(--ok); }
    .bad { color: var(--bad); }
    .footer { margin-top: 12px; font-size: 12px; color: var(--muted); text-align:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Hiragana Flashcards</h1>
      <div class="stats">
        <span class="pill">Card <span id="pos">1</span>/<span id="total">0</span></span>
        <span class="pill">Streak <span id="streak">0</span></span>
        <span class="pill">Voice: <span id="voiceStatus">‚Ä¶</span></span>
      </div>
    </header>

    <div class="card" id="card" role="button" aria-label="Flashcard. Tap to flip.">
      <div class="toprow">
        <div class="pill" id="modeLabel">Type romaji ‚Üì</div>
        <button class="iconbtn" id="speak" type="button" aria-label="Speak kana">üîä Speak</button>
      </div>

      <div class="big" id="front">„ÅÇ</div>
      <div class="small" id="back"></div>
      <div class="hint">Tap card to flip ‚Ä¢ Swipe left/right or use buttons ‚Ä¢ Press Enter to check</div>

      <div class="answerBox">
        <input id="answer" class="answerInput" type="text" inputmode="latin" autocomplete="off" autocapitalize="none" spellcheck="false"
               placeholder="Type romaji (e.g., a, shi/si, tsu/tu, kya)‚Ä¶" />
        <div id="feedback" class="feedback" aria-label="answer feedback">‚Äî</div>
      </div>
    </div>

    <div class="controls">
      <button id="prev">‚óÄÔ∏é Back</button>
      <button id="flip">Flip</button>
      <button id="next">Next ‚ñ∂Ô∏é</button>
    </div>

    <div class="row2">
      <button id="know">I knew it ‚úÖ</button>
      <button id="dont">Missed ‚ùå</button>
      <button id="shuffle">Random üé≤</button>
    </div>

    <div class="toggles">
      <label><input type="checkbox" id="showRomaji" checked /> Show romaji on flip</label>
      <label><input type="checkbox" id="includeDiacritics" checked /> Include „Çõ„Çú („Åå/„Å± etc.)</label>
      <label><input type="checkbox" id="includeCombo" checked /> Include combos („Åç„ÇÉ/„Åó„ÇÉ etc.)</label>
      <label><input type="checkbox" id="autoSpeak" /> Auto-speak on new card</label>
    </div>

    <div class="footer">Progress stays on this device (local storage). No account.</div>
  </div>

<script>
  const base = [
    ["„ÅÇ","a"],["„ÅÑ","i"],["„ÅÜ","u"],["„Åà","e"],["„Åä","o"],
    ["„Åã","ka"],["„Åç","ki"],["„Åè","ku"],["„Åë","ke"],["„Åì","ko"],
    ["„Åï","sa"],["„Åó","shi"],["„Åô","su"],["„Åõ","se"],["„Åù","so"],
    ["„Åü","ta"],["„Å°","chi"],["„Å§","tsu"],["„Å¶","te"],["„Å®","to"],
    ["„Å™","na"],["„Å´","ni"],["„Å¨","nu"],["„Å≠","ne"],["„ÅÆ","no"],
    ["„ÅØ","ha"],["„Å≤","hi"],["„Åµ","fu"],["„Å∏","he"],["„Åª","ho"],
    ["„Åæ","ma"],["„Åø","mi"],["„ÇÄ","mu"],["„ÇÅ","me"],["„ÇÇ","mo"],
    ["„ÇÑ","ya"],["„ÇÜ","yu"],["„Çà","yo"],
    ["„Çâ","ra"],["„Çä","ri"],["„Çã","ru"],["„Çå","re"],["„Çç","ro"],
    ["„Çè","wa"],["„Çí","wo"],["„Çì","n"]
  ];

  const diacritics = [
    ["„Åå","ga"],["„Åé","gi"],["„Åê","gu"],["„Åí","ge"],["„Åî","go"],
    ["„Åñ","za"],["„Åò","ji"],["„Åö","zu"],["„Åú","ze"],["„Åû","zo"],
    ["„Å†","da"],["„Å¢","ji"],["„Å•","zu"],["„Åß","de"],["„Å©","do"],
    ["„Å∞","ba"],["„Å≥","bi"],["„Å∂","bu"],["„Åπ","be"],["„Åº","bo"],
    ["„Å±","pa"],["„Å¥","pi"],["„Å∑","pu"],["„Å∫","pe"],["„ÅΩ","po"]
  ];

  const combos = [
    ["„Åç„ÇÉ","kya"],["„Åç„ÇÖ","kyu"],["„Åç„Çá","kyo"],
    ["„Åó„ÇÉ","sha"],["„Åó„ÇÖ","shu"],["„Åó„Çá","sho"],
    ["„Å°„ÇÉ","cha"],["„Å°„ÇÖ","chu"],["„Å°„Çá","cho"],
    ["„Å´„ÇÉ","nya"],["„Å´„ÇÖ","nyu"],["„Å´„Çá","nyo"],
    ["„Å≤„ÇÉ","hya"],["„Å≤„ÇÖ","hyu"],["„Å≤„Çá","hyo"],
    ["„Åø„ÇÉ","mya"],["„Åø„ÇÖ","myu"],["„Åø„Çá","myo"],
    ["„Çä„ÇÉ","rya"],["„Çä„ÇÖ","ryu"],["„Çä„Çá","ryo"],
    ["„Åé„ÇÉ","gya"],["„Åé„ÇÖ","gyu"],["„Åé„Çá","gyo"],
    ["„Åò„ÇÉ","ja"],["„Åò„ÇÖ","ju"],["„Åò„Çá","jo"],
    ["„Å≥„ÇÉ","bya"],["„Å≥„ÇÖ","byu"],["„Å≥„Çá","byo"],
    ["„Å¥„ÇÉ","pya"],["„Å¥„ÇÖ","pyu"],["„Å¥„Çá","pyo"]
  ];

  const els = {
    front: document.getElementById("front"),
    back: document.getElementById("back"),
    pos: document.getElementById("pos"),
    total: document.getElementById("total"),
    streak: document.getElementById("streak"),
    card: document.getElementById("card"),
    prev: document.getElementById("prev"),
    next: document.getElementById("next"),
    flip: document.getElementById("flip"),
    know: document.getElementById("know"),
    dont: document.getElementById("dont"),
    shuffle: document.getElementById("shuffle"),
    showRomaji: document.getElementById("showRomaji"),
    includeDiacritics: document.getElementById("includeDiacritics"),
    includeCombo: document.getElementById("includeCombo"),
    speak: document.getElementById("speak"),
    autoSpeak: document.getElementById("autoSpeak"),
    answer: document.getElementById("answer"),
    feedback: document.getElementById("feedback"),
    voiceStatus: document.getElementById("voiceStatus"),
  };

  const storeKey = "hiragana_flash_v3";
  const state = loadState();

  function buildDeck() {
    let deck = [...base];
    if (els.includeDiacritics.checked) deck = deck.concat(diacritics);
    if (els.includeCombo.checked) deck = deck.concat(combos);
    return deck;
  }

  let deck = buildDeck();
  let index = clamp(state.index ?? 0, 0, deck.length - 1);
  let flipped = false;
  let streak = state.streak ?? 0;

  // -------------------------
  // Audio (Text-to-Speech)
  // -------------------------
  let chosenVoice = null;

  function pickJapaneseVoice() {
    const synth = window.speechSynthesis;
    if (!synth) return null;
    const voices = synth.getVoices?.() || [];
    const ja = voices.filter(v => (v.lang || "").toLowerCase().startsWith("ja"));
    return ja[0] || null;
  }

  function refreshVoice() {
    chosenVoice = pickJapaneseVoice();
    els.voiceStatus.textContent = chosenVoice ? "JA" : (window.speechSynthesis ? "TTS" : "off");
  }

  if ("speechSynthesis" in window) {
    window.speechSynthesis.onvoiceschanged = () => refreshVoice();
    setTimeout(refreshVoice, 50);
    setTimeout(refreshVoice, 400);
  } else {
    els.voiceStatus.textContent = "off";
  }

  function speakKana(text) {
    if (!("speechSynthesis" in window)) return;
    try {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ja-JP";
      if (chosenVoice) u.voice = chosenVoice;
      u.rate = 0.9;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    } catch {}
  }

  // -------------------------
  // Typing / answer checking
  // -------------------------
  function normalizeRomaji(s) {
    return (s || "").trim().toLowerCase().replace(/\s+/g, "");
  }

  // Expand acceptable spellings for a given romaji answer
  function romajiAliases(romaji) {
    const r = normalizeRomaji(romaji);
    const out = new Set([r]);

    // Core single-syllable alternates
    const map = {
      "shi": ["si"],
      "chi": ["ti"],
      "tsu": ["tu"],
      "fu":  ["hu"],
      "ji":  ["zi"],
    };
    if (map[r]) map[r].forEach(x => out.add(x));

    // Common special cases
    if (r === "wo") out.add("o"); // „Çí often typed as 'o'
    if (r === "n") out.add("nn"); // some type nn

    // Y≈çon alternates (sha/syu/syo etc.)
    const yoy = [
      ["sha","sya"], ["shu","syu"], ["sho","syo"],
      ["ja","zya"],  ["ju","zyu"],  ["jo","zyo"],
      ["cha","tya"], ["chu","tyu"], ["cho","tyo"],
      ["cha","cya"], ["chu","cyu"], ["cho","cyo"],
      ["ja","jya"],  ["ju","jyu"],  ["jo","jyo"],
      ["sha","shya"],["shu","shyu"],["sho","shyo"],
      ["cha","chya"],["chu","chyu"],["cho","chyo"],
    ];
    for (const [a,b] of yoy) {
      if (r === a) out.add(b);
    }

    // „Å¢ and „Å• are often typed as di/du (even if taught as ji/zu)
    if (r === "ji") out.add("di");
    if (r === "zu") out.add("du");

    return out;
  }

  function acceptableRomajiSet(correctRomaji) {
    return romajiAliases(correctRomaji);
  }

  // -------------------------
  // Rendering & navigation
  // -------------------------
  function currentCard() { return deck[index]; }

  function resetTypingUI() {
    els.answer.value = "";
    els.feedback.textContent = "‚Äî";
    els.feedback.classList.remove("ok", "bad");
  }

  function render() {
    deck = buildDeck();
    if (deck.length === 0) return;
    if (index > deck.length - 1) index = 0;

    const [kana, romaji] = currentCard();
    els.front.textContent = kana;
    els.total.textContent = deck.length;
    els.pos.textContent = (index + 1);
    els.streak.textContent = streak;

    if (flipped && els.showRomaji.checked) {
      els.back.textContent = romaji;
    } else {
      els.back.textContent = "";
    }

    saveState();
  }

  function flip() { flipped = !flipped; render(); }

  function next() {
    flipped = false;
    index = (index + 1) % deck.length;
    resetTypingUI();
    render();
    if (els.autoSpeak.checked) speakKana(currentCard()[0]);
  }

  function prev() {
    flipped = false;
    index = (index - 1 + deck.length) % deck.length;
    resetTypingUI();
    render();
    if (els.autoSpeak.checked) speakKana(currentCard()[0]);
  }

  function knewIt() { streak += 1; next(); }
  function missed() { streak = 0; next(); }

  // Random: bring a random flashcard to the front immediately
  function jumpRandom() {
    if (deck.length <= 1) return;
    let newIndex = index;
    while (newIndex === index) {
      newIndex = Math.floor(Math.random() * deck.length);
      if (deck.length === 2) break;
    }
    index = newIndex;
    flipped = false;
    resetTypingUI();
    render();
    if (els.autoSpeak.checked) speakKana(currentCard()[0]);
  }

  function checkAnswer() {
    const typed = normalizeRomaji(els.answer.value);
    const correct = normalizeRomaji(currentCard()[1]);
    const accepted = acceptableRomajiSet(correct);

    if (!typed) {
      els.feedback.textContent = "‚Äî";
      els.feedback.classList.remove("ok", "bad");
      return;
    }

    if (accepted.has(typed)) {
      els.feedback.textContent = "‚úÖ";
      els.feedback.classList.add("ok");
      els.feedback.classList.remove("bad");
      streak += 1;
      saveState();
    } else {
      els.feedback.textContent = "‚ùå";
      els.feedback.classList.add("bad");
      els.feedback.classList.remove("ok");
      streak = 0;
      saveState();
    }
    els.streak.textContent = streak;
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function saveState() {
    const payload = {
      index,
      streak,
      showRomaji: els.showRomaji.checked,
      includeDiacritics: els.includeDiacritics.checked,
      includeCombo: els.includeCombo.checked,
      autoSpeak: els.autoSpeak.checked,
      ts: Date.now()
    };
    localStorage.setItem(storeKey, JSON.stringify(payload));
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(storeKey);
      if (!raw) return {};
      return JSON.parse(raw);
    } catch { return {}; }
  }

  // Restore toggles
  if (state.showRomaji !== undefined) els.showRomaji.checked = state.showRomaji;
  if (state.includeDiacritics !== undefined) els.includeDiacritics.checked = state.includeDiacritics;
  if (state.includeCombo !== undefined) els.includeCombo.checked = state.includeCombo;
  if (state.autoSpeak !== undefined) els.autoSpeak.checked = state.autoSpeak;

  // -------------------------
  // Events
  // -------------------------
  els.card.addEventListener("click", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if (tag === "input" || tag === "button") return;
    flip();
  });

  els.flip.addEventListener("click", flip);
  els.next.addEventListener("click", next);
  els.prev.addEventListener("click", prev);
  els.know.addEventListener("click", knewIt);
  els.dont.addEventListener("click", missed);
  els.shuffle.addEventListener("click", jumpRandom);
  els.speak.addEventListener("click", () => speakKana(currentCard()[0]));

  [els.showRomaji, els.includeDiacritics, els.includeCombo, els.autoSpeak].forEach(cb =>
    cb.addEventListener("change", () => {
      deck = buildDeck();
      index = 0;
      flipped = false;
      streak = 0;
      resetTypingUI();
      render();
      refreshVoice();
    })
  );

  let typeTimer = null;
  els.answer.addEventListener("input", () => {
    clearTimeout(typeTimer);
    typeTimer = setTimeout(checkAnswer, 120);
  });

  els.answer.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      checkAnswer();
    }
  });

  let startX = null;
  els.card.addEventListener("touchstart", (e) => { startX = e.touches[0].clientX; }, {passive:true});
  els.card.addEventListener("touchend", (e) => {
    if (startX === null) return;
    const endX = e.changedTouches[0].clientX;
    const dx = endX - startX;
    startX = null;
    if (Math.abs(dx) < 50) return;
    if (dx < 0) next(); else prev();
  }, {passive:true});

  render();
  resetTypingUI();
  refreshVoice();
</script>
</body>
</html>

